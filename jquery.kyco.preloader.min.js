// jquery.kyco.preloader brought to you by www.kyco.co.za. Copyright 2013 Cornelius Weidmann. Distributed under the GPL.
(function(e){var t={init:function(t){var n={preloadSelector:true,truePercentage:true,showInContainer:false,hideBackground:false,progressiveReveal:false,silentMode:false,debugMode:false,useOpacity:false,hidePercentage:false,loaderText:"loading images, please wait...",animateDuration:0,fadeOutDuration:100,showImagesBeforeComplete:true,beforeComplete:function(){},onComplete:function(){}};var r=e.extend({},n,t);return this.each(function(){function v(e){var t=new RegExp("^(http|https|ftp)://([a-zA-Z0-9.-]+(:[a-zA-Z0-9.&%$-]+)*@)*((25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9]).(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9]|0).(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9]|0).(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[0-9])|localhost|([a-zA-Z0-9-]+.)*[a-zA-Z0-9-]+.(com|edu|gov|int|mil|net|org|biz|arpa|info|name|pro|aero|coop|museum|[a-zA-Z]{2}))(:[0-9]+)*(/($|[a-zA-Z0-9.,?'\\+&%$#=~_-]+))*$");return t.test(e)}function g(){i.forEach(function(t){function f(e){if(r.truePercentage){u+=e.fileSize/a*100;if(s===o){u=100}}else{u=s/a*100}}var n=e('<img src="'+w(t.node)+'" />');var i=false;n.load(function(){s++;f(t);y(u);if(r.progressiveReveal){E(t.node)}}).error(function(){if(!i){i=true;if(r.debugMode){var t=n.attr("src")?n.attr("src"):n.css("background-image");if(h.find("pre").length!==0){e("<div>Not found: "+t+"</div>").appendTo(h.find("pre"))}else{h.html("Failed loading images:<pre><div>Not found: "+t+"</div></pre>")}h.css("text-align","left")}else{h.html("failed loading one or more images... please refresh the page")}}})})}function y(e){var t=p.width();d.stop().animate({width:e+"%"},{duration:r.animateDuration,easing:"linear",step:function(){h.children("span").html(Math.round(d.width()/t*100))},complete:function(){h.children("span").html(Math.round(e));if(s===o){d.queue(function(){if(r.showImagesBeforeComplete){i.forEach(function(e){E(e.node)});r.beforeComplete.call(this);f.animate({opacity:"0"},r.fadeOutDuration,function(){f.remove();r.onComplete.call(this)})}else{r.beforeComplete.call(this);f.animate({opacity:"0"},r.fadeOutDuration,function(){i.forEach(function(e){E(e.node)});f.remove();r.onComplete.call(this)})}})}}})}function b(t){function i(t){var r=t.children();if(r.length>0){r.each(function(){var t=e(this);n.push(t);if(t.children().length>0){i(t)}})}}var n=[];if(t.children().length>0){if(r.preloadSelector){n.push(t)}i(t)}else if(r.preloadSelector){n.push(t)}return n}function w(e){if(e.css("background-image")!=="none"){return e.css("background-image").replace(/^url\(["']?/,"").replace(/["']?\)$/,"")}else if(e.css("background-image")==="none"&&e.attr("data-bg")){return e.attr("data-bg").replace(/^url\(["']?/,"").replace(/["']?\)$/,"")}else{return e.attr("src")}}function E(e){if(!r.useOpacity){e.show()}else{e.css("opacity","1")}if(e.attr("data-bg")){e.css("background-image",e.attr("data-bg"))}}var t=e(this);var n=b(t);var i=[];var s=0;var o=0;var u=0;var a=0;var f=e('<div id="kyco_preloader"></div>');if(!r.showInContainer){f.appendTo("body")}else{f.appendTo(t);t.css("position","relative");f.css("position","absolute")}var l=e('<div class="kyco_loader_overlay"></div>').appendTo(f);var c=e('<div class="kyco_loader"></div>').appendTo(f);if(!r.hidePercentage){var h=e('<div class="kyco_progress_notification">'+r.loaderText+' <span class="kyco_progress_percentage">'+u+"</span>%</div>").appendTo(c)}else{var h=e('<div class="kyco_progress_notification">'+r.loaderText+"</div>").appendTo(c)}var p=e('<div class="kyco_progress_bar"></div>').appendTo(c);var d=e('<div class="kyco_progress_loaded"></div>').appendTo(p);if(r.silentMode){f.hide()}n.forEach(function(e){if(e.is("img")||v(e.css("background-image").substring(4,e.css("background-image").length-1))){if(!(r.preloadSelector&&r.showInContainer&&e===t)){if(!r.useOpacity){e.hide()}else{e.css("opacity","0")}}else if(r.hideBackground){e.attr("data-bg",e.css("background-image")).css("background-image","none")}var n={node:e,fileSize:0};i.push(n);o++}});if(r.truePercentage){var m=0;i.forEach(function(t){e.ajax({type:"HEAD",url:w(t.node),success:function(e,n,r){t.fileSize=parseInt(r.getResponseHeader("Content-Length"));a+=parseInt(r.getResponseHeader("Content-Length"));m++;if(m===o){g()}},error:function(n,i,s){if(r.debugMode){if(n.status===404){if(h.find("pre").length!==0){e("<div>Not found: "+w(t.node)+"</div>").appendTo(h.find("pre"))}else{h.html("Failed loading images:<pre><div>Not found: "+w(t.node)+"</div></pre>")}}else if(n.status===0){if(h.find("pre").length!==0){e("<div>Invalid cross-domain call: "+w(t.node)+"</div>").appendTo(h.find("pre"))}else{h.html("Failed loading images:<pre><div>Invalid cross-domain call: "+w(t.node)+"</div></pre>")}}else{if(h.find("pre").length!==0){e("<div>Couldn't get file size, set {truePercentage: false}</div>").appendTo(h.find("pre"))}else{h.html("Failed loading images:<pre><div>Couldn't get file size, set {truePercentage: false}</div></pre>")}}h.css("text-align","left")}else{h.html("failed loading one or more images... please refresh the page")}}})})}else{a=o;g()}})}};e.fn.kycoPreload=function(n){if(t[n]){return t[n].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof n==="object"||!n){return t.init.apply(this,arguments)}else{e.error("Method "+n+" does not exist on jQuery.kycoPreload")}}})(jQuery)
